<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Steelyard · Internet Beijing Time</title>

<!-- 同目录需有：background.png, steelyard.png, 1.png…14.png, TINY5x3-100.otf, Anthony.otf -->

<style>
  /* 字体 */
  @font-face{
    font-family:'Tiny5x3';
    src:url('TINY5x3-100.otf') format('opentype');
    font-display:swap;
  }
  @font-face{
    font-family:'Anthony';
    src:url('Anthony.otf') format('opentype');
    font-display:swap;
  }

  /* 背景 20% 透明 */
  html,body{height:100%;margin:0}
  body{
    position:relative; background:transparent; overflow-x:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  body::before{
    content:""; position:fixed; inset:0;
    background:url('background.png') center/cover no-repeat;
    opacity:.2; z-index:-1;  /* 20% */
  }

  /* 顶部按钮（只有边框） */
  .topbar{position:fixed; top:16px; right:16px; z-index:40;}
  .broider{
    border-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFQAAABUCAYAAAAcaxDBAAAB4ElEQVR4Aeza4W2DMBCG4bRrdJTO06k6T0fpHK0QKEJHz5KP10CTNxIJ4Nxn5+HkX3m9+UIFBEU5bzdBBYUF4Dg7VFBYAI6zQwWFBeA4O1RQWACOs0MFhQXguEqHwkt4rDhB4ecpqKCwABxnhwoKC8BxdqigsAAch3fo2+fXz/qA17s7br226Xx3YAjAQUP+010KCj9yQa8O+v3x/rI+lvXeP6Z968jjPvFysl7bdL7cxj7sUIxyDhJ0dsDeBcUo56DhoHG/nPatI484//yzx70PBx239GsmCwo/F0EFhQXgODtUUFgAjrNDnwgU/qnHxNmhsLOggsICcJwdKigsAMfZoYLCAnCcHSooLADH2aGCwgJw3KN1KMzTHydov1mzQtAmT/+goP1mzQpBmzz9g4L2mzUrBG3y9A8K2m/WrBgOGv/HFP9rNPo6zt/UAAaHgwJr/FcRgsKPS9Crg8Y9Ma437mmjr+P8f6wvfmXXtR26i29bLOjWZNcdQXfxbYtx0Lgnbqc8987o9eGg53KdP7ug8DMQVFBYAI6zQwWFBeA4O1RQWKAWl1bZoSlNbUDQmltaJWhKUxsQtOaWVgma0tQGBK25pVWCpjS1AUFrbmmVoClNbUDQmltaJWhKUxv4BQAA///xSMxYAAAABklEQVQDAE9EQLg3RXKiAAAAAElFTkSuQmCC") 28 / 28px / 0 round;
    border-width:28px; border-style:solid;
  }
  .btn{
    background:transparent; color:#111; font-weight:700;
    padding:10px 18px; cursor:pointer; user-select:none;
  }

  /* 时间选择竖条：只有边框，可滚动 */
  .time-panel{
    position:fixed; top:72px; right:16px; z-index:40;
    display:none;
    background:transparent;              /* 不要背景 */
    padding:8px;
    box-sizing:border-box; width:160px;
    max-height:70vh; overflow-y:auto; -webkit-overflow-scrolling:touch;
  }
  .time-list{list-style:none; margin:0; padding:0;}
  .time-item{
    padding:8px 10px; margin:4px 0;
    cursor:pointer; text-align:center; user-select:none;
    font-variant-numeric:tabular-nums;
  }
  .time-item:hover{text-decoration:underline;}

  /* 中心舞台与 steelyard */
  .stage{min-height:100svh; display:grid; place-items:center;}
  .wrap{position:relative; width:min(62vw,600px); aspect-ratio:1/1;}
  #steelyard{
    position:absolute; inset:0; width:100%; height:100%; object-fit:contain;
    transform-origin:50% 50%; will-change:transform;
    pointer-events:none; user-select:none;
  }

  /* 右侧 1/4 处只显示时间（TINY5x3 放大两倍） */
  .time-readout{
    position:absolute; top:25%; left:100%; transform:translate(18px,-50%);
    white-space:nowrap;
    font-family:'Tiny5x3', ui-monospace, Menlo, Consolas, monospace;
    font-size:clamp(40px, 6.2vw, 100px); letter-spacing:.04em; user-select:none;
  }

  /* 全屏随机出现层（乱放、大小不一） */
  .spawn-layer{position:fixed; inset:0; z-index:30; pointer-events:none;}
  .item{
    position:absolute; pointer-events:auto; cursor:grab; user-select:none;
    transform-origin:50% 50%;
  }
  .item:active{cursor:grabbing;}
  .item img{display:block; width:100%; height:100%; object-fit:contain;}

  /* —— 拖入 steelyard 后的小尺寸（保持小，不会巨大） —— */
  .dropped{
    position:absolute; z-index:3; cursor:grab;
    width:clamp(32px, 4.5vw, 56px) !important;
    height:clamp(32px, 4.5vw, 56px) !important;
  }
  .dropped img{
    width:100% !important; height:100% !important; object-fit:contain;
  }

  /* 仅在 steelyard 上的物品悬停显示提示框 */
  .tooltip{
    position:absolute; left:50%; bottom:100%;
    transform:translate(-50%,-10px) scale(.98);
    opacity:0; pointer-events:none; transition:opacity .15s, transform .15s; z-index:4;
    white-space:nowrap;
  }
  .dropped:hover .tooltip{opacity:1; transform:translate(-50%,-14px) scale(1);}

  /* 提示框样式（你给的） */
  .tip-frame{
    border-radius:39px;
    background:linear-gradient(145deg,#ffffff,#dedede);
    box-shadow:17px 17px 42px #bebebe, -17px -17px 42px #ffffff;
    padding:8px 12px;
  }
  .tip-text{font-family:'Anthony', cursive, system-ui; font-size:clamp(14px,2vw,18px);}
</style>
</head>
<body>

  <!-- 按钮 -->
  <div class="topbar" id="topbar">
    <button id="btnTime" class="btn broider" aria-expanded="false">Time Selection</button>
  </div>

  <!-- 时间选择竖条（只有边框，可滚动到最底部） -->
  <div id="timePanel" class="time-panel broider" role="listbox" aria-label="Pick a time (30-minute steps)">
    <ul id="timeList" class="time-list"></ul>
  </div>

  <!-- 中心 steelyard 舞台 -->
  <main class="stage">
    <div class="wrap" id="wrap" aria-label="steelyard dropzone">
      <img id="steelyard" src="steelyard.png" alt="steelyard" draggable="false"/>
      <div id="timeText" class="time-readout">--:--</div>
    </div>
  </main>

  <!-- 全屏随机出现层 -->
  <div id="spawnLayer" class="spawn-layer" aria-live="polite"></div>

<script>
/* ========= 配置 ========= */
const ITEM_FILES = Array.from({length:14}, (_,i)=>`${i+1}.png`);
const ITEM_WORDS = ["nature","Hobby","Going out","manual","Attend class","Have a meal","music","Happy","Work","snack","play","dress up","friend","rest"];

const $ = s => document.querySelector(s);
const wrap = $('#wrap'), steelyard = $('#steelyard'), timeText = $('#timeText');
const spawnLayer = $('#spawnLayer'), btnTime = $('#btnTime'), timePanel = $('#timePanel'), timeList = $('#timeList');

let uid = 1;
let bag = [];                         // 确保 1..14 每轮都出现一次
let selectedBaseMinutes = null;       // 选择面板设定的基准时间（分钟），null=跟随互联网北京时

/* ========= 工具 ========= */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } return a; }
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
function hhmm(mm){ const h=Math.floor(mm/60), m=mm%60; return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0'); }
/* 互联网北京时（UTC+8）分钟值 0..1439 */
function bjMinutesNow(){ const now=new Date(); const u=now.getUTCHours()*60+now.getUTCMinutes(); return (u+8*60)%1440; }
/* 右半圆角度：-90°(0h) → +90°(24h) */
function minutesToAngle(mins){ return -90 + (mins/1440)*180; }

/* ========= 时间选择（只有边框，可滚动） ========= */
function buildTimeList(){
  timeList.innerHTML = '';
  for(let m=30; m<1440; m+=30){
    const li=document.createElement('li'); li.className='time-item'; li.textContent=hhmm(m);
    li.addEventListener('click', (e)=>{ e.stopPropagation(); selectedBaseMinutes=m%1440; refresh(); });
    timeList.appendChild(li);
  }
  const last=document.createElement('li'); last.className='time-item'; last.textContent='00:00';
  last.addEventListener('click',(e)=>{ e.stopPropagation(); selectedBaseMinutes=0; refresh(); });
  timeList.appendChild(last);
}

/* ========= 随机生成（of 循环） ========= */
function refillBag(){ bag = shuffle([...Array(14).keys()]); } // 0..13
function spawnOne(){
  if(bag.length===0) refillBag();
  // 用 of 循环按要求“每次点击生成 1 个”
  for(const _ of [0]){
    const idx = bag.pop();                              // 0..13
    const base = 56 + Math.random()*120;               // 初生尺寸（大小不一）
    const scale = 0.85 + Math.random()*0.8;            // 0.85~1.65
    const rot = Math.random()*50 - 25;                 // -25°~25°

    // 外层容器（可承载 tooltip）
    const box = document.createElement('div');
    box.className='item'; box.id='itm-'+(uid++); box.dataset.idx=String(idx);
    box.style.width=base+'px'; box.style.height=base+'px';
    box.style.transform=`rotate(${rot}deg) scale(${scale.toFixed(2)})`;
    box.setAttribute('draggable','true');

    // 全屏随机位置，尽量避开右上角控件
    const vw=Math.max(document.documentElement.clientWidth,320);
    const vh=Math.max(document.documentElement.clientHeight,240);
    let left=Math.random()*(vw-base), top=Math.random()*(vh-base);
    const guardX=vw-220, guardY=180;
    if(left>guardX && top<guardY){ left-=220; top+=160; }
    box.style.left=left+'px'; box.style.top=top+'px';

    const img=document.createElement('img');
    img.src=ITEM_FILES[idx]; img.alt=ITEM_WORDS[idx]; img.draggable=false;
    box.appendChild(img);

    // 拖拽数据
    box.addEventListener('dragstart',(e)=>{
      const r=box.getBoundingClientRect();
      const dx=e.clientX-r.left, dy=e.clientY-r.top;
      e.dataTransfer.setData('text/plain', JSON.stringify({ id:box.id, idx, dx, dy }));
      e.dataTransfer.effectAllowed='move';
    });

    spawnLayer.appendChild(box);
  }
}

/* ========= 拖到 steelyard 上并叠加时间 ========= */
function droppedCount(){ return wrap.querySelectorAll('.dropped[data-on="1"]').length; }

function refresh(){
  const base = (selectedBaseMinutes==null) ? bjMinutesNow() : selectedBaseMinutes;
  const plus = droppedCount()*30;
  const mins = (base + plus) % 1440;
  timeText.textContent = hhmm(mins);
  steelyard.style.transform = `rotate(${minutesToAngle(mins)}deg)`;
}

/* 仅允许在 steelyard 图片矩形范围内放置 */
function pointerInSteelyard(x,y){
  const r=steelyard.getBoundingClientRect();
  return x>=r.left && x<=r.right && y>=r.top && y<=r.bottom;
}
function attachToSteelyard(info, clientX, clientY){
  const el=document.getElementById(info.id);
  if(!el) return;

  const rWrap=wrap.getBoundingClientRect();
  const x=clientX - rWrap.left - info.dx;
  const y=clientY - rWrap.top  - info.dy;

  const already = el.classList.contains('dropped');
  if(!already){
    /* 清理生成期内联样式并使用小尺寸 */
    el.style.removeProperty('width');
    el.style.removeProperty('height');
    el.style.removeProperty('transform');
    el.classList.remove('item');
    el.classList.add('dropped');
    el.setAttribute('data-on','1');

    // 仅在 steelyard 上添加提示框
    if(!el.querySelector('.tooltip')){
      const tip=document.createElement('div'); tip.className='tooltip';
      const frame=document.createElement('div'); frame.className='tip-frame';
      const txt=document.createElement('div'); txt.className='tip-text';
      txt.textContent=ITEM_WORDS[Number(el.dataset.idx||0)];
      frame.appendChild(txt); tip.appendChild(frame); el.appendChild(tip);
    }

    wrap.appendChild(el); // 移入 steelyard
  }

  // 约束在 wrap 内部
  const maxX=wrap.clientWidth - el.offsetWidth;
  const maxY=wrap.clientHeight - el.offsetHeight;
  el.style.left = clamp(x,0,Math.max(0,maxX))+'px';
  el.style.top  = clamp(y,0,Math.max(0,maxY))+'px';

  refresh();
}

/* steelyard 作为 drop 区域 */
wrap.addEventListener('dragover',(e)=>{
  if(!pointerInSteelyard(e.clientX,e.clientY)) return;
  e.preventDefault(); e.dataTransfer.dropEffect='move';
});
wrap.addEventListener('drop',(e)=>{
  if(!pointerInSteelyard(e.clientX,e.clientY)) return;
  e.preventDefault();
  try{
    const info=JSON.parse(e.dataTransfer.getData('text/plain'));
    attachToSteelyard(info, e.clientX, e.clientY);
  }catch{}
});

/* 跟随互联网北京时（未手动选择时）每 20s 更新一次 */
setInterval(()=>{ if(selectedBaseMinutes==null) refresh(); }, 20000);

/* ========= 初始化 ========= */
(function init(){
  buildTimeList();
  bag = shuffle([...Array(14).keys()]);

  // 初始刷新
  refresh();

  // 统一的一组事件监听（避免重复绑定导致“开了又关”或“一次两张”）
  btnTime.addEventListener('click',(e)=>{
    e.stopPropagation();                      // 不让冒泡到 document
    const open = timePanel.style.display!=='block';
    timePanel.style.display = open ? 'block' : 'none';
    btnTime.setAttribute('aria-expanded', open?'true':'false');
  });

  document.addEventListener('click',(e)=>{
    // 点击按钮或面板：不生成、不关闭（由按钮自己控制）
    if (e.target.closest('#topbar') || e.target.closest('#timePanel')) return;

    // 关闭面板
    timePanel.style.display='none';
    btnTime.setAttribute('aria-expanded','false');

    // 生成 1 张
    spawnOne();
  });

  // 面板内点击不向上冒泡
  timePanel.addEventListener('click', e=>e.stopPropagation());
})();
</script>
</body>
</html>
