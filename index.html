<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cube · OPEN prize</title>
<style>
*{box-sizing:border-box;margin:0}
html,body{height:100%;background:#eef4fb}

/* 字体 */
@font-face{font-family:'BianzhidaiGrid';src:url('bianzhidai_COLR-grid.otf') format('opentype');font-display:swap}
@font-face{font-family:'BianzhidaiStitches';src:url('bianzhidai-Stitches.otf') format('opentype');font-display:swap}
@font-face{font-family:'Anthony';src:url('Anthony.otf') format('opentype');font-display:swap}

/* 标题与右下提示 */
#title{
  position:fixed;top:16px;left:50%;transform:translateX(-50%);
  font-family:'BianzhidaiGrid',system-ui;white-space:nowrap;
  font-size:clamp(24px,4vw,48px);color:#123;z-index:5
}
#hint{
  position:fixed;right:16px;bottom:12px;
  font-family:'BianzhidaiGrid',system-ui;font-size:clamp(12px,1.8vw,18px);
  color:#345;opacity:.9;z-index:5
}

/* —— 3D 立方体 —— */
#cubeView{position:fixed;inset:0;display:grid;place-items:center;z-index:1}
#scene{position:relative;width:min(80vmin,900px);height:min(80vmin,900px);perspective:1400px}
#cube{
  position:absolute;left:50%;top:50%;
  transform-style:preserve-3d;cursor:grab;
  --w:560px;--h:520px;--d:520px;
  /* 平滑“缩小并移动到底部”的动画 */
  transition:transform 1000ms cubic-bezier(.2,.8,.2,1);
}
.face{
  position:absolute;left:50%;top:50%;
  transform-style:preserve-3d;backface-visibility:hidden;overflow:hidden;
  background-repeat:no-repeat,no-repeat,no-repeat;
  background-size:100% 100%,100% 100%,cover;
  background-position:center,center,center;
}
.face::after{content:"";position:absolute;inset:0;background:inherit;opacity:.5;pointer-events:none}

.base{display:none}
.front,.back{width:var(--w);height:var(--h);margin-left:calc(-.5*var(--w));margin-top:calc(-.5*var(--h))}
.right,.left{width:var(--d);height:var(--h);margin-left:calc(-.5*var(--d));margin-top:calc(-.5*var(--h))}
.top,.bottom{width:var(--w);height:var(--d);margin-left:calc(-.5*var(--w));margin-top:calc(-.5*var(--d))}
.front {transform:translateZ(calc(.5*var(--d)))}
.back  {transform:rotateY(180deg) translateZ(calc(.5*var(--d)))}
.right {transform:rotateY( 90deg) translateZ(calc(.5*var(--w)))}
.left  {transform:rotateY(-90deg) translateZ(calc(.5*var(--w)))}
.top   {transform:rotateX( 90deg) translateZ(calc(.5*var(--h)))}
.bottom{transform:rotateX(-90deg) translateZ(calc(.5*var(--h)))}

/* 悬浮问候语（不拦截点击） */
#hover{position:fixed;top:50%;transform:translateY(-50%);max-width:28vw;white-space:pre-line;line-height:1.15;
  font-family:'BianzhidaiStitches',system-ui;font-size:clamp(14px,2vw,22px);color:#1e2a3a;display:none;user-select:none;
  pointer-events:none;z-index:4}
.leftPos{left:4vw}.rightPos{right:4vw}

/* —— 打字编辑页（保持之前逻辑） —— */
#editor{position:fixed;inset:0;display:none;background:#f5f7fb;z-index:10}
#editor.active{display:block}
#topBar{position:absolute;left:12px;top:12px;z-index:10}
.miaoni{
  border-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAAqCAYAAADFw8lbAAABMklEQVR4AezWS2rEMBCE4SS73CGL3P9UWeQOWSZ48RlTIFpjlIE2HhDlVj+k+j0Lv700+fW96M/X9+9xzQI/9hyfz/ZnX1+inLx/frxuCx37qf+dd14foohQDiod1W9vYVvZP6rPOrF62ocoBxuF47I/q3oREM/2V3V9iHKORGrlVF5fzpM/q+b1Icqpm48UMaovdTavbnSeffP7EXXzkXK4Wkfn5f71iKbDZ8c30dXEb6I30dUEVs+73H90NaCH591EH0ZWNFyPqO/H1VqA3NP9iFak8jt0txoP6mJ7D+Vpda7GPkQ5cvOzmoTEs/PUp7pfH6Kzjqs6zhERV32Z10fl+xBFgHJQ6ag+SZgzqpdPVU/7EE0nGXOU++JV+dGbcE5foghRjipVn1r1yVd9bYj+AQAA//9nUAlzAAAABklEQVQDAFf+wGTex3CgAAAAAElFTkSuQmCC') 14 / 14px / 0 round;
  border-width:14px;border-style:solid;background:transparent;color:#111;
  display:inline-flex;align-items:center;justify-content:center;
  font-family:'Anthony',system-ui;line-height:1;border-radius:10px;cursor:pointer
}
#back{padding:10px 14px;font-size:18px}
#done{position:absolute;right:14px;bottom:14px;z-index:10;padding:10px 14px;font-size:18px}
#adder{position:absolute;left:14px;bottom:14px;z-index:10;display:flex;align-items:center;gap:10px}
#add{width:52px;height:52px;border-radius:12px;font-size:32px;font-weight:800;font-family:'Anthony',system-ui}
#file{display:none}
#photo{position:absolute;inset:0;background-size:cover;background-position:center;opacity:.5;pointer-events:none;z-index:1}
#minis{position:absolute;inset:0;pointer-events:none;z-index:2}
.mini{position:absolute;opacity:.6;transform-origin:center;max-width:50%;max-height:50%}
#gridWrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:3;pointer-events:none}
#grid{width:100vw;height:100vh;display:grid}
.cell{display:grid;place-items:center}
.ch{display:inline-block;line-height:1;transform-origin:center;will-change:transform;
  font:600 120px/1 system-ui,Helvetica,Arial;color:#111;transition:transform .45s ease,font-weight .3s ease}
#caret{position:absolute;left:4vmin;top:4vmin;width:1px;height:32px;background:#111;opacity:1;animation:blink 1s step-end infinite;z-index:4}
@keyframes blink{50%{opacity:0}}
#ghost{position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;border:0}
.gridPOS .ch{font-weight:100;transform:scaleX(.33)}
.gridNEG .ch{font-weight:900;transform:scaleX(3)}

/* —— OPEN 按钮（确保可点） —— */
.clouds{
  border-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFQAAABUCAYAAAAcaxDBAAACrklEQVR4Aeyc4W7CMAyEM97/nRk/0KScU1+vdoGVQ5Mmx+eL8xGZbj+4Db9aCRhoK84xDNRAmwk029Ebeicv7IfI76ivxmw/zFf3Y/UUKDNwfiZgoDOPcmSgZYSzQQCqzpyqvlo/H4dHuB/G3CFXBKC53FlGwEAZITFvoCIwJg9Af/jrVAVr+NTNH+Zsf5y5GAegzND5nICB5nzkrIHKyPKCABRnAotz+3r20/ZnJwpAWYHzOQEDzfnIWQOVkeUFN5xRuTxmu+tVP1UfT5CvPB5NpR/f0JynnDVQGVleYKA5Hzl7kwbEDvFGB5vLOywlyeZGzwTOXIyfssO/fEMPo1sXGuiay+FVAz2Mbl14eaDqjFT1iPXyQPHAZ8cG2kzYQN8NFGcMxs39le2kh9iFWG3AN1QlRvQGSgCpaQNViRE9BarOSFWf9PcRKTwPxtgkBYoFjnMCBprzkbMGKiPLCyjQxaOZtJRv//4szkSM1Q4pUNXw2/UG2nwDDPRsoDhDWNzcz8vtpA+EhRgb9g1FIsXYQIsAsdxAkUgxLgPFGVvsp1pO67FfFlNDEJSBgt/XhwbafAUM9Gygi0ctaam5v7IdzkjVUK33DVUJE72BEkBq2kBVYkR/eaDSB8AOMeHprxligNT85W+oCqSqN9AqQag30DEASS000Bq/UG2gAUltwUBr/EI1BYp/y7I47CAuMH/Mi/ZUjv4YMwMKlBk4PxMw0JlHOTLQMsLZIABVZ8ZsN4Zar+qr+1XrWb8BKG7oWCNgoBovqjZQikgTBKA7/iUoSVg7ktkOMdsP8zssV5K/NfQLQFHgWCNgoBovqjZQikgTlIHicxmLtfaimvmzfHTsXSkD7W3n/7sZaPN7aKCvBto9k9Cv+TzU7uz9fUPpW6AJDFTjRdUGShFpgl8AAAD//7BHuHEAAAAGSURBVAMA6nOQNX7lUgIAAAAASUVORK5CYII=') 28 / 28px / 0 round;
  border-width:28px;border-style:solid;background:transparent;
}
#openBtn{
  position:fixed;right:16px;bottom:58px;display:none;
  color:rgb(226,101,101);font-family:'Anthony',system-ui;
  font-size:clamp(18px,2.6vw,26px);line-height:1;text-transform:uppercase;
  padding:12px 22px;border-radius:12px;cursor:pointer;user-select:none;
  animation:pulse 1.6s ease-in-out infinite alternate;
  z-index:9999; pointer-events:auto;
}
@keyframes pulse{from{transform:scale(1)}to{transform:scale(1.08)}}

/* 奖品：固定等尺寸正方形框、微光 + 缩放 + 浮动 + 渐显 */
#prize{
  position:fixed;left:50%;top:38%;
  transform:translate(-50%,-50%);
  display:none;opacity:0;transition:opacity 600ms ease;
  z-index:2000;pointer-events:none
}
#prize.show{display:block;opacity:1}
#prize .float{display:inline-block;animation:floatY 3.2s ease-in-out infinite}
#prize img{
  display:block;
  width:min(32vmin,320px);height:min(32vmin,320px); /* 等尺寸框 */
  object-fit:contain;
  filter: drop-shadow(0 0 14px rgba(255,255,255,.9))
          drop-shadow(0 0 26px rgba(255,255,230,.75));
  animation:pulseSize 1.9s ease-in-out infinite alternate
}
@keyframes floatY{0%{transform:translateY(-8px)}50%{transform:translateY(8px)}100%{transform:translateY(-8px)}}
@keyframes pulseSize{from{transform:scale(.96)}to{transform:scale(1.04)}}
</style>
</head>
<body>
<div id="title">Open your time blind box</div>
<div id="hint">You can only get it if you complete all 6 sides.</div>
<button id="openBtn" class="clouds">OPEN!</button>

<div id="prize"><div class="float"><img id="prizeImg" alt="prize"/></div></div>

<div id="hover"></div>

<div id="cubeView">
  <div id="scene">
    <div id="cube">
      <div class="face front"><div class="base"></div></div>
      <div class="face back"><div class="base"></div></div>
      <div class="face right"><div class="base"></div></div>
      <div class="face left"><div class="base"></div></div>
      <div class="face top"><div class="base"></div></div>
      <div class="face bottom"><div class="base"></div></div>
    </div>
  </div>
</div>

<!-- —— 打字编辑页：保持你之前的逻辑（省略与任务无关的改动） —— -->
<div id="editor">
  <div id="photo"></div>
  <div id="minis"></div>
  <div id="topBar"><button id="back" class="miaoni">Back</button></div>
  <div id="gridWrap"><div id="grid"></div></div>
  <div id="caret"></div>
  <div id="adder"><button id="add" class="miaoni">+</button><input id="file" type="file" accept="image/*" multiple/></div>
  <button id="done" class="miaoni">Complete</button>
  <textarea id="ghost" spellcheck="false" autocomplete="off" autocapitalize="off"></textarea>
</div>

<script>
/* 资源 */
const SKY=['sky1.jpg','sky2.jpeg','sky3.jpeg','sky4.jpeg','sky5.jpeg','sky6.jpeg'];
const PRIZES=['1.png','2.png','3.png','4.png','5.png','6.png','7.png'];

/* 元素 */
const scene=document.getElementById('scene'),cube=document.getElementById('cube');
const faces=[...document.querySelectorAll('.face')];
const cubeView=document.getElementById('cubeView');
const editor=document.getElementById('editor'),backBtn=document.getElementById('back'),doneBtn=document.getElementById('done');
const addBtn=document.getElementById('add'),fileInput=document.getElementById('file');
const grid=document.getElementById('grid'),gridWrap=document.getElementById('gridWrap'),caret=document.getElementById('caret');
const photo=document.getElementById('photo'),minisLayer=document.getElementById('minis'),ghost=document.getElementById('ghost');
const hover=document.getElementById('hover');
const openBtn=document.getElementById('openBtn'),prize=document.getElementById('prize'),prizeImg=document.getElementById('prizeImg');

let currentFace=0, compact=false;
const faceData=Array.from({length:6},()=>({raw:'',minis:[],textOverlay:null,miniOverlay:null,done:false}));

/* 初始化立方体 */
function initBox(){
  const S=Math.min(innerWidth,innerHeight)*0.62;
  const w=S*(0.7+Math.random()*0.4),h=S*(0.7+Math.random()*0.4),d=S*(0.7+Math.random()*0.4);
  cube.style.setProperty('--w',w+'px');cube.style.setProperty('--h',h+'px');cube.style.setProperty('--d',d+'px');
  faces.forEach((f,i)=>{ f.style.backgroundImage=`url(${SKY[i%SKY.length]})`; });
  applyRot();
}
addEventListener('resize',()=>{initBox(); if(editor.classList.contains('active')) render(ghost.value)});

/* 旋转与“缩小到下方”的平滑过渡 */
let dragging=false,pid=0,sx=0,sy=0,rx=-18,ry=-22;
function applyRot(){
  const base=`rotateX(${rx}deg) rotateY(${ry}deg)`;
  cube.style.transform= (compact?`translateY(34vh) scale(.38) `:'') + base;
}
scene.addEventListener('pointerdown',e=>{dragging=true;pid=e.pointerId;sx=e.clientX;sy=e.clientY;scene.setPointerCapture(pid);cube.style.cursor='grabbing'});
scene.addEventListener('pointermove',e=>{if(!dragging)return;const dx=e.clientX-sx,dy=e.clientY-sy;sx=e.clientX;sy=e.clientY;ry+=dx*.4;rx-=dy*.4;applyRot()});
['pointerup','pointercancel','pointerleave'].forEach(t=>scene.addEventListener(t,()=>{if(!dragging)return;dragging=false;try{scene.releasePointerCapture(pid)}catch{} cube.style.cursor='grab'}));

/* 悬浮问候语 */
const PROMPTS=["How’s your day going?","How’s today treating you?","How are you feeling today?","Having a good day so far?","How’s everything going today?","You doing alright today?"];
let pool=shuffle([...PROMPTS]);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a}
function showHover(){ if(!pool.length) pool=shuffle([...PROMPTS]); const s=pool.pop(); hover.textContent=s.split(/\s+/).join("\n"); hover.style.display='block'; hover.classList.remove('leftPos','rightPos'); hover.classList.add(Math.random()<.5?'leftPos':'rightPos')}
function hideHover(){hover.style.display='none'}
faces.forEach((f,i)=>{
  f.addEventListener('mouseenter',showHover); f.addEventListener('mouseleave',hideHover);
  f.addEventListener('dblclick',()=>openEditor(i),true);
  let last=0,lx=0,ly=0;
  f.addEventListener('pointerup',e=>{
    const now=Date.now(),dt=now-last,dx=e.clientX-lx,dy=e.clientY-ly;
    if(dt<450&&Math.hypot(dx,dy)<14){openEditor(i);last=0}else{last=now;lx=e.clientX;ly=e.clientY}},true);
});

/* （以下是打字/保存/贴图逻辑，与此前你通过的版本一致，只保留关键函数） */
function clean(s){return (s||'').replace(/[^\w\s.,;:!?'"()\[\]{}\-]/g,'')}
function chars(s){return Array.from(s)}
function bestGrid(n){if(n<=0)return{c:1,r:1};const W=innerWidth,H=innerHeight;let best={c:1,r:n,score:0};for(let c=1;c<=n;c++){const r=Math.ceil(n/c);const score=Math.min(W/c,H/r);if(score>best.score)best={c,r,score}}return best}
const cache=new Map();
function measure(ch){const key=ch||' ';if(cache.has(key))return cache.get(key);const t=document.createElement('span');t.className='ch';t.style.position='absolute';t.style.visibility='hidden';t.style.left='-9999px';t.textContent=key===' '?'M':key;document.body.appendChild(t);const r=t.getBoundingClientRect();document.body.removeChild(t);const res={w:Math.max(1,r.width),h:Math.max(1,r.height)};cache.set(key,res);return res;}
function render(raw){
  const a=chars(clean(raw)); const n=Math.max(1,a.length);
  const {c,r}=bestGrid(n);
  grid.style.gridTemplateColumns=`repeat(${c},1fr)`;
  grid.style.gridTemplateRows=`repeat(${r},1fr)`;
  grid.innerHTML='';
  const cw=innerWidth/c, ch=innerHeight/r;
  for(let i=0;i<n;i++){
    const cell=document.createElement('div');cell.className='cell';
    const sp=document.createElement('span');sp.className='ch';
    const chv=a[i]; sp.textContent= chv===' ' ? ' ' : chv;
    const box=measure(chv);
    const sx=(cw*0.99)/box.w*1.04, sy=(ch*0.99)/box.h*1.03;
    const jx=(Math.random()*2-1)*3.5, jy=(Math.random()*2-1)*3.5, rt=(Math.random()*2-1)*1.2, s2=1+(Math.random()*2-1)*.03;
    sp.style.transform=`translate(${jx}px,${jy}px) rotate(${rt}deg) scale(${sx*s2},${sy*s2})`;
    cell.appendChild(sp); grid.appendChild(cell);
  }
  const first=grid.querySelector('.ch'); if(first){const rct=first.getBoundingClientRect(); caret.style.height=Math.max(14,Math.min(rct.height,240))+'px'}
}
addEventListener('resize',()=>{if(editor.classList.contains('active'))render(ghost.value)});

const POS=("happy cheerful pleasant glad sweet elated joy joyful delight delighted hope hopeful optimism optimistic calm relax relaxed relaxing peace peaceful content contented confident gratitude grateful thankful chill ease easy light smile enjoy enjoyed enjoying inspired proud succeed success winning win achievement achieved achieving love awesome great fantastic wonderful amazing").split(/\s+/);
const NEG=("sad bad awful displeased anxious anxiety worry worried fearful fear panic stressed stress pressure overwhelmed overthinking depressed depression upset down angry anger furious rage irritable annoyed mad hate tired exhausted burnout confused lost helpless hopeless lonely guilt guilty shame frustrated frustration miserable terrible worse worst cry crying").split(/\s+/);
function mood(raw){const s=(raw||'').toLowerCase();let pos=0,neg=0;POS.forEach(w=>{if(s.includes(w))pos++});NEG.forEach(w=>{if(s.includes(w))neg++});return pos>neg?'pos':(neg>pos?'neg':'neu')}

function openEditor(idx){
  currentFace=idx;
  photo.style.backgroundImage=`url(${SKY[idx%SKY.length]})`;
  rebuildMinis();
  ghost.value=faceData[idx].raw||'';
  render(ghost.value);
  cubeView.style.display='none'; editor.classList.add('active');
  setTimeout(()=>{ghost.focus();ghost.selectionStart=ghost.selectionEnd=ghost.value.length;},0);
}
document.getElementById('back').addEventListener('click',()=>{applyFace(currentFace); editor.classList.remove('active'); cubeView.style.display='grid'});

/* 输入兜底 */
editor.addEventListener('pointerdown',e=>{const ui=e.target.closest('#done,#back,#adder,#file'); if(!ui){ghost.focus();}});
document.addEventListener('keydown',e=>{
  if(!editor.classList.contains('active')) return;
  if(e.key==='Enter'){ e.preventDefault(); saveFace(); return; }
  if(document.activeElement!==ghost){
    e.preventDefault();
    if(e.key==='Backspace'){ ghost.value=ghost.value.slice(0,-1); render(ghost.value); return; }
    if(e.key.length===1){ ghost.value += e.key; render(ghost.value); return; }
  }
});
ghost.addEventListener('input',()=>render(ghost.value));

/* mini 拼贴 */
function rebuildMinis(){
  minisLayer.innerHTML='';
  const arr=faceData[currentFace].minis||[];
  for(const m of arr){
    const im=document.createElement('img'); im.className='mini'; im.src=m.src;
    const wf=Math.min(.5,m.wf||.25), hf=Math.min(.5,m.hf||.25);
    im.style.width=(wf*100)+'%'; im.style.height=(hf*100)+'%';
    im.style.left=((m.x??.5)*100)+'%'; im.style.top=((m.y??.5)*100)+'%';
    im.style.transform=`translate(-50%,-50%) rotate(${m.rot||0}deg)`;
    minisLayer.appendChild(im);
  }
}
addBtn.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',async e=>{
  const files=[...e.target.files||[]]; if(!files.length)return;
  for(const file of files){
    const src=await toDataURL(file);
    const side=.18+Math.random()*(.5-.18), ratio=.75+Math.random()*.5;
    const wf=side, hf=Math.min(.5,side*ratio);
    const x=Math.max(.2,Math.min(.8,Math.random())), y=Math.max(.2,Math.min(.8,Math.random()));
    const rot=-25+Math.random()*50;
    faceData[currentFace].minis.push({src,wf,hf,x,y,rot});
  }
  rebuildMinis(); e.target.value='';
});
function toDataURL(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file)})}

/* 文字与 mini 合成贴图（输出等比例 PNG） */
async function makeTextOverlay(raw,outW,outH){
  const cvs=document.createElement('canvas'); cvs.width=outW; cvs.height=outH; const ctx=cvs.getContext('2d'); ctx.clearRect(0,0,outW,outH);
  ctx.fillStyle='#111'; ctx.textAlign='center'; ctx.textBaseline='middle';
  const a=Array.from(clean(raw)); const n=Math.max(1,a.length);
  const best=(function(){let b={c:1,r:n,score:0};for(let c=1;c<=n;c++){const r=Math.ceil(n/c);const s=Math.min(outW/c,outH/r);if(s>b.score)b={c,r,score:s}}return b})();
  const {c,r}=best, cw=outW/c, ch=outH/r, md=mood(raw);
  for(let i=0;i<n;i++){
    const chv=a[i], col=i%c, row=(i/c)|0, cx=(col+.5)*cw, cy=(row+.5)*ch;
    const meas=document.body.__m||(document.body.__m=(function(){const t=document.createElement('span');t.style.position='absolute';t.style.left='-9999px';t.style.font='600 120px system-ui,Helvetica,Arial';t.textContent='M';document.body.appendChild(t);const r=t.getBoundingClientRect();document.body.removeChild(t);return {w:r.width,h:r.height}})());
    const sx0=(cw*0.99)/meas.w*1.04, sy0=(ch*0.99)/meas.h*1.03;
    let scaleX=1, weight=600; if(md==='pos'){scaleX=1/3; weight=100}else if(md==='neg'){scaleX=3; weight=900}
    const jx=(Math.random()*2-1)*Math.min(6,cw*0.06), jy=(Math.random()*2-1)*Math.min(6,ch*0.06), rt=(Math.random()*2-1)*1.2*Math.PI/180, s2=1+(Math.random()*2-1)*.03;
    ctx.save(); ctx.translate(cx+jx,cy+jy); ctx.rotate(rt); ctx.scale(sx0*s2*scaleX, sy0*s2);
    ctx.font=`${weight} 120px system-ui,Helvetica,Arial`; ctx.fillText(chv===' ' ? ' ' : chv,0,0); ctx.restore();
  }
  return cvs.toDataURL('image/png');
}
async function makeMiniOverlay(outW,outH,minis){
  const cvs=document.createElement('canvas'); cvs.width=outW; cvs.height=outH; const ctx=cvs.getContext('2d'); ctx.clearRect(0,0,outW,outH);
  if(Array.isArray(minis)){
    for(const m of minis){
      await new Promise((res,rej)=>{
        const im=new Image();
        im.onload=()=>{const w=outW*Math.min(.5,m.wf||.25), h=outH*Math.min(.5,m.hf||.25);
          const x=outW*(m.x??.5)-w/2, y=outH*(m.y??.5)-h/2;
          ctx.save(); ctx.globalAlpha=.6; ctx.translate(x+w/2,y+h/2); ctx.rotate((m.rot||0)*Math.PI/180); ctx.drawImage(im,-w/2,-h/2,w,h); ctx.restore(); res(); };
        im.onerror=rej; im.src=m.src;
      });
    }
  }
  return cvs.toDataURL('image/png');
}
function applyFace(idx){
  const f=faces[idx];
  const sky=`url(${SKY[idx%SKY.length]})`;
  const mini=faceData[idx].miniOverlay ? `url(${faceData[idx].miniOverlay})` : null;
  const text=faceData[idx].textOverlay ? `url(${faceData[idx].textOverlay})` : null;
  const layers=[text,mini,sky].filter(Boolean).join(',');
  f.style.backgroundImage=layers||sky;
}

/* 保存，全部完成后显示 OPEN! */
async function saveFace(){
  doneBtn.disabled=true; doneBtn.textContent='Saving...';
  try{
    const raw=ghost.value||'';
    faceData[currentFace].raw=raw;

    gridWrap.classList.remove('gridPOS','gridNEG');
    const md=mood(raw); if(md==='pos')gridWrap.classList.add('gridPOS'); else if(md==='neg')gridWrap.classList.add('gridNEG');
    setTimeout(()=>gridWrap.classList.remove('gridPOS','gridNEG'),420);

    const cs=getComputedStyle(cube);
    const W=parseFloat(cs.getPropertyValue('--w'))||560;
    const H=parseFloat(cs.getPropertyValue('--h'))||520;
    const D=parseFloat(cs.getPropertyValue('--d'))||520;
    const fe=faces[currentFace];
    let fw=W, fh=H;
    if(fe.classList.contains('right')||fe.classList.contains('left')){fw=D;fh=H}
    if(fe.classList.contains('top')||fe.classList.contains('bottom')){fw=W;fh=D}

    let outW=Math.max(64,Math.round(fw)), outH=Math.max(64,Math.round(fh));
    const scale=1024/Math.max(outW,outH); outW=Math.max(128,Math.round(outW*scale)); outH=Math.max(128,Math.round(outH*scale));

    const [textPNG, miniPNG]=await Promise.all([
      makeTextOverlay(raw,outW,outH),
      makeMiniOverlay(outW,outH,faceData[currentFace].minis)
    ]);
    faceData[currentFace].textOverlay=textPNG;
    faceData[currentFace].miniOverlay=miniPNG;
    faceData[currentFace].done=true;

    applyFace(currentFace);
    editor.classList.remove('active'); cubeView.style.display='grid';

    if(faceData.every(f=>f.done)) openBtn.style.display='inline-flex';
  }catch(err){
    alert('Save failed: '+(err?.message||err));
  }finally{
    doneBtn.disabled=false; doneBtn.textContent='Complete';
  }
}
document.getElementById('done').addEventListener('click',saveFace);

/* —— OPEN：平滑缩小并下移 + 中心偏上出现“统一尺寸”的奖品 —— */
openBtn.addEventListener('click',()=>{
  openBtn.disabled=true; openBtn.style.pointerEvents='none';
  compact=true; applyRot();                 // 触发 CSS transition：缩小并下移
  const pick=PRIZES[(Math.random()*PRIZES.length)|0];
  prizeImg.src=pick;
  prize.classList.add('show');              // 渐显
});

/* 启动 */
(function(){ initBox(); faces.forEach((_,i)=>applyFace(i)); })();
</script>
</body>
</html>
